# Generated by gen.py script
# Do not edit this file manually

name: Build and Push
on:
    push:
        branches: ["master"]
    pull_request:
        branches: ["master"]
    schedule:
        - cron: "0 2 * * 1-5"

jobs:
    hadoop-cluster:
        name: Build Hadoop Cluster
        runs-on: ubuntu-latest
        strategy:
            matrix:
                tags:
                    - v2.10.1-hadoop2
        env:
            IMAGE_NAME: hadoop
            IMAGE_TAG: "${{ matrix.tags }}"
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - uses: dorny/paths-filter@v2
              id: changes
              with:
                  filters: |
                      src:
                        - '${{ env.IMAGE_NAME }}/${{ matrix.tags }}/**'
                        - '.github/workflows/ci.yaml'

            - name: Login to Docker Hub
              if: steps.changes.outputs.src == 'true'
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Log in to the Container registry
              if: steps.changes.outputs.src == 'true'
              uses: docker/login-action@65b78e6e13532edd9afa3aa52ac7964289d1a9c1
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.REGISTRY_ACTION }}

            # - name: Set up Docker Buildx
            #   if: steps.changes.outputs.src == 'true'
            #   id: buildx
            #   uses: docker/setup-buildx-action@v1

            # - name: Build and push to Docker Registry
            #   if: steps.changes.outputs.src == 'true'
            #   id: docker_build
            #   uses: docker/build-push-action@v2
            #   with:
            #       context: ${{ github.workspace }}
            #       file: ./${{ env.IMAGE_NAME }}/${{ env.IMAGE_TAG }}/Dockerfile
            #       tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            #       push: true

            - name: Extract metadata (tags, labels) for Docker
              id: meta
              if: steps.changes.outputs.src == 'true'
              uses: docker/metadata-action@9ec57ed1fcdbf14dcef7dfbe97b2010124a938b7
              with:
                  images: |
                      phanvigiaii/hadoop-v2.10.1
                      ghcr.io/${{ github.repository }}

            - name: Build and push Docker images
              if: steps.changes.outputs.src == 'true'
              uses: docker/build-push-action@3b5e8027fcad23fda98b2e3ac259d8d67585f671
              with:
                  context: ${{ github.workspace }}
                  file: ./${{ env.IMAGE_NAME }}/${{ env.IMAGE_TAG }}/Dockerfile
                  tags: ${{ steps.meta.outputs.tags }}
                  labels: ${{ steps.meta.outputs.labels }}
                  push: true

            - name: Image digest
              if: steps.changes.outputs.src == 'true'
              run: echo ${{ steps.docker_build.outputs.digest }}
